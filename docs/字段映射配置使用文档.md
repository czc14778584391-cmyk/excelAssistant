# 字段映射配置使用文档

## 目录

- [概述](#概述)
- [基础语法](#基础语法)
- [功能详解](#功能详解)
- [使用示例](#使用示例)
- [常见问题](#常见问题)

## 概述

字段映射配置用于将源表格的字段映射到目标表格的字段，支持多种灵活的映射方式，包括字段查找、拼接、格式化、计算等功能。

### 配置文件位置

- **按公司主体拆分汇总**：`{userData}/config/generateMultiple.json`
- **多表合规化合并**：`{userData}/config/generateSingle.json`

### 配置文件格式

```json
{
  "表格名称": {
    "目标字段1": "映射表达式1",
    "目标字段2": "映射表达式2"
  }
}
```

## 基础语法

### 1. 单个字段映射

最简单的映射方式，直接指定源字段名：

```json
{
  "*账号": "银行卡号"
}
```

**说明**：目标字段 `*账号` 的值来自源表格的 `银行卡号` 字段。

### 2. 字段拼接（&）

使用 `&` 连接多个字段或固定文字：

```json
{
  "*用途": "付款申请单号&'这种用途'",
  "开户地": "省&'省'&市&'市'"
}
```

**说明**：
- `付款申请单号&'这种用途'`：将 `付款申请单号` 字段的值与固定文字 `这种用途` 拼接
- `省&'省'&市&'市'`：将 `省` 字段值 + `省` + `市` 字段值 + `市` 拼接

### 3. 固定文字（单引号）

使用单引号 `'` 包裹固定文字：

```json
{
  "备注": "'固定备注文字'"
}
```

**说明**：目标字段的值直接使用固定文字，不依赖源字段。

### 4. 或关系（|）

使用 `|` 分隔多个可能的源字段，系统会查找第一个存在的字段：

```json
{
  "*金额": "本次付款金额|支出|消费"
}
```

**说明**：依次查找 `本次付款金额`、`支出`、`消费` 字段，使用第一个找到的字段值。

## 功能详解

### 日期格式化

使用 `:date('格式')` 对日期字段进行格式化。

#### 支持的格式占位符

| 占位符 | 说明 | 示例 |
|--------|------|------|
| `YYYY` | 4位年份 | 2024 |
| `YY` | 2位年份 | 24 |
| `MM` | 2位月份（补零） | 01-12 |
| `M` | 月份（不补零） | 1-12 |
| `DD` | 2位日期（补零） | 01-31 |
| `D` | 日期（不补零） | 1-31 |
| `HH` | 2位小时（补零） | 00-23 |
| `H` | 小时（不补零） | 0-23 |
| `mm` | 2位分钟（补零） | 00-59 |
| `m` | 分钟（不补零） | 0-59 |
| `ss` | 2位秒（补零） | 00-59 |
| `s` | 秒（不补零） | 0-59 |

#### 使用示例

```json
{
  "交易日期": "日期:date('YYYY-MM-DD')",
  "创建时间": "时间戳:date('YYYY/MM/DD HH:mm:ss')",
  "年月": "日期:date('YYYY年MM月')"
}
```

**说明**：
- `日期:date('YYYY-MM-DD')`：将日期字段格式化为 `2024-01-01` 格式
- `时间戳:date('YYYY/MM/DD HH:mm:ss')`：格式化为 `2024/01/01 12:00:00` 格式
- `日期:date('YYYY年MM月')`：格式化为 `2024年01月` 格式

#### 支持的日期输入格式

系统会自动识别以下日期格式：
- Excel 日期序列号（如：44927）
- ISO 格式（如：2024-01-01）
- 常见字符串格式（如：2024/01/01、2024年1月1日等）

### 数值计算

使用 `:calc('表达式')` 对数值字段进行数学运算。

#### 支持的运算符

- `+`：加法
- `-`：减法
- `*`：乘法
- `/`：除法

#### 使用示例

```json
{
  "总金额": "金额:calc('*1.1')",
  "含税金额": "金额:calc('*1.13')",
  "折扣后": "原价:calc('*0.8')",
  "加手续费": "金额:calc('+手续费')"
}
```

**说明**：
- `金额:calc('*1.1')`：金额乘以 1.1（加10%）
- `金额:calc('*1.13')`：金额乘以 1.13（加13%税费）
- `原价:calc('*0.8')`：原价乘以 0.8（打8折）
- `金额:calc('+手续费')`：金额加上 `手续费` 字段的值

**注意**：表达式中的 `$` 表示当前字段值，但可以省略。例如 `:calc('*1.1')` 等同于 `:calc('$*1.1')`。

### 条件判断

使用 `?:` 进行三元运算（如果字段A存在则用A，否则用B，再否则用默认值）。

#### 语法格式

```
字段A?:字段B:'默认值'
```

#### 使用示例

```json
{
  "状态": "是否通过?:'是':'否'",
  "类型": "类型字段?:'默认类型'",
  "备注": "原备注?:备用备注:'无备注'"
}
```

**说明**：
- `是否通过?:'是':'否'`：如果 `是否通过` 字段存在且非空，使用该字段值；否则使用 `是`；如果都不存在，使用 `否`
- `类型字段?:'默认类型'`：如果 `类型字段` 存在，使用该字段值；否则使用 `默认类型`
- `原备注?:备用备注:'无备注'`：优先使用 `原备注`，如果不存在则用 `备用备注`，都不存在则用 `无备注`

### 默认值

使用 `||` 当字段为空时使用默认值。

#### 语法格式

```
字段||'默认值'
```

#### 使用示例

```json
{
  "名称": "字段名||'默认名称'",
  "备注": "备注字段||'无'"
}
```

**说明**：
- `字段名||'默认名称'`：如果 `字段名` 为空或不存在，使用 `默认名称`
- `备注字段||'无'`：如果 `备注字段` 为空，使用 `无`

### 字符串操作

#### 去除空格（trim）

使用 `:trim()` 去除字段值的前后空格。

```json
{
  "代码": "代码:trim()",
  "名称": "名称:trim()"
}
```

#### 大小写转换

使用 `:upper()` 转大写，`:lower()` 转小写。

```json
{
  "代码": "代码:upper()",
  "名称": "名称:lower()"
}
```

#### 字符串替换

使用 `:replace('查找','替换')` 进行文本替换。

```json
{
  "备注": "原备注:replace('旧','新')",
  "状态": "状态:replace('是','1')"
}
```

**说明**：
- `原备注:replace('旧','新')`：将 `原备注` 字段中的所有 `旧` 替换为 `新`
- `状态:replace('是','1')`：将 `状态` 字段中的 `是` 替换为 `1`

#### 字符串截取

使用 `:substring(开始,结束)` 截取字符串。

```json
{
  "代码": "完整代码:substring(0,5)",
  "简称": "全称:substring(0,3)"
}
```

**说明**：
- `完整代码:substring(0,5)`：截取 `完整代码` 字段的前5个字符（索引从0开始）
- `全称:substring(0,3)`：截取 `全称` 字段的前3个字符

**注意**：索引从0开始，结束位置不包含在内。

### 链式调用

可以连续使用多个函数，按顺序执行：

```json
{
  "代码": "代码:trim():upper()",
  "备注": "备注:trim():replace('旧','新')"
}
```

**说明**：
- `代码:trim():upper()`：先去除空格，再转大写
- `备注:trim():replace('旧','新')`：先去除空格，再替换文本

## 使用示例

### 示例1：基础映射

```json
{
  "招行代发整理表": {
    "*账号": "银行卡号",
    "*户名": "收款账户",
    "*金额": "本次需打款金额"
  }
}
```

### 示例2：字段拼接

```json
{
  "招行代发整理表": {
    "*账号": "银行卡号",
    "*户名": "收款账户",
    "*金额": "本次需打款金额",
    "开户行": "支行",
    "开户地": "收货银行名称",
    "汇款备注": "流程编号&报销",
    "辅助列": "付款主体"
  }
}
```

### 示例3：或关系和拼接

```json
{
  "招行代发整理表": {
    "*金额": "本次付款金额|支出|消费",
    "*用途": "付款申请单号&'这种用途'",
    "开户地": "省&'省'&市&'市'"
  }
}
```

### 示例4：日期格式化

```json
{
  "交易记录表": {
    "交易日期": "日期:date('YYYY-MM-DD')",
    "创建时间": "时间戳:date('YYYY/MM/DD HH:mm:ss')",
    "年月": "日期:date('YYYY年MM月')"
  }
}
```

### 示例5：数值计算

```json
{
  "财务汇总表": {
    "原金额": "金额",
    "总金额": "金额:calc('*1.1')",
    "含税金额": "金额:calc('*1.13')",
    "最终金额": "金额:calc('+手续费')"
  }
}
```

### 示例6：条件判断和默认值

```json
{
  "状态表": {
    "状态": "是否通过?:'是':'否'",
    "类型": "类型字段?:'默认类型'",
    "备注": "原备注?:备用备注:'无备注'",
    "名称": "字段名||'默认名称'"
  }
}
```

### 示例7：字符串操作

```json
{
  "数据处理表": {
    "代码": "代码:trim():upper()",
    "备注": "原备注:replace('旧','新')",
    "简称": "全称:substring(0,3)"
  }
}
```

### 示例8：复杂混合场景

```json
{
  "综合报表": {
    "*金额": "本次付款金额|支出|消费",
    "*用途": "付款申请单号&'这种用途'",
    "开户地": "省&'省'&市&'市'",
    "交易日期": "日期:date('YYYY-MM-DD')",
    "总金额": "金额:calc('*1.1')",
    "状态": "是否通过?:'是':'否'",
    "备注": "原备注:replace('旧','新')||'无备注'",
    "代码": "代码:trim():upper()"
  }
}
```

## 处理优先级

当映射表达式包含多个操作时，按以下优先级处理：

1. **或关系（|）** - 最高优先级
2. **条件判断（?:）**
3. **默认值（||）**
4. **函数调用（:函数名）**
5. **字段拼接（&）**
6. **单个字段** - 最低优先级

### 优先级示例

```json
{
  "示例字段": "字段1|字段2:date('YYYY-MM-DD')&'后缀'"
}
```

**处理流程**：
1. 先处理或关系：查找 `字段1` 或 `字段2`
2. 如果找到，对结果应用日期格式化
3. 最后拼接固定文字 `后缀`

## 常见问题

### Q1: 字段名找不到怎么办？

**A**: 系统支持模糊匹配，会尝试以下方式查找字段：
- 精确匹配（区分大小写）
- 忽略大小写匹配
- 包含匹配（字段名包含配置中的关键词）

如果所有方式都找不到，该字段的值将为空字符串。

### Q2: 日期格式化失败怎么办？

**A**: 如果日期解析失败，系统会：
1. 尝试多种日期格式解析
2. 如果都失败，返回原始值
3. 如果原始值也为空，返回空字符串

### Q3: 数值计算时字段不是数字怎么办？

**A**: 系统会尝试将字段值转换为数字：
- 如果是数字字符串（如 "123"），会转换为数字
- 如果包含非数字字符，会尝试提取数字部分
- 如果无法转换，计算结果为 0 或返回原始值

### Q4: 单引号内的文字可以包含单引号吗？

**A**: 目前不支持在固定文字内使用单引号。如果需要包含单引号，可以考虑：
- 使用其他字符替代
- 或者将这部分内容作为字段值处理

### Q5: 可以嵌套使用函数吗？

**A**: 支持链式调用，例如：
```json
{
  "代码": "代码:trim():upper()"
}
```

但不支持嵌套调用，例如：
```json
{
  "代码": "代码:replace('a', 'b:upper()')"  // 不支持
}
```

### Q6: 如何调试映射配置？

**A**: 在任务执行日志中会显示：
- 字段查找过程
- 映射解析结果
- 错误信息（如果有）

建议：
1. 先使用简单的映射测试
2. 逐步添加复杂功能
3. 查看日志了解处理过程

### Q7: 配置文件格式错误怎么办？

**A**: 系统会：
1. 尝试解析 JSON 格式
2. 如果格式错误，会显示错误信息
3. 建议使用 JSON 格式验证工具检查配置文件

### Q8: 支持哪些文件格式？

**A**: 目前支持：
- Excel 文件（.xlsx, .xls）
- CSV 文件（如果系统支持）

### Q9: 字段名有特殊字符怎么办？

**A**: 字段名中的特殊字符会被保留，但建议：
- 避免使用控制字符
- 避免使用可能导致解析错误的字符（如未配对的引号）

### Q10: 性能如何？

**A**: 
- 对于小到中等规模的文件（< 10万行），处理速度很快
- 对于大型文件，处理时间会相应增加
- 复杂映射表达式会增加处理时间

## 最佳实践

1. **保持配置简洁**：优先使用简单的映射，必要时再使用复杂功能
2. **测试配置**：在正式使用前，先用小样本测试配置是否正确
3. **查看日志**：处理过程中查看日志，了解字段匹配情况
4. **备份配置**：修改配置前先备份，避免配置丢失
5. **命名规范**：使用清晰的字段名，便于维护

## 更新日志

### v1.0.0
- 支持基础字段映射
- 支持字段拼接（&）
- 支持固定文字（单引号）
- 支持或关系（|）
- 支持日期格式化
- 支持数值计算
- 支持条件判断
- 支持默认值
- 支持字符串操作（trim、upper、lower、replace、substring）
- 支持链式调用

---

**文档版本**：1.0.0  
**最后更新**：2024年
